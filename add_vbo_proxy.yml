---
- name: Register Linux Proxy in Veeam Backup for Microsoft 365
  hosts: all
  gather_facts: no
  become: no

  # ... (Dine vars er kommenteret ud) ...

  tasks:

    - name: Tilføj Linux Proxy i Veeam Backup for Microsoft 365
      ansible.windows.win_powershell:
        script: |
          Import-Module Veeam.Archiver.PowerShell


          $proxyHostname = "{{ proxy_fqdn }}"
          $pUser = "{{ proxy_username }}"
          $pPass = ConvertTo-SecureString -String "{{ proxy_password }}" -AsPlainText -Force
          $LinuxCred = New-VBOLinuxCredential -Account $pUser -ElevateAccountToRoot:$true -Password $pPass


          $existing = Get-VBOProxy | Where-Object { $_.Hostname -eq $proxyHostname }

          if (!$existing) {


              Add-VBOProxy -Hostname $proxyHostname -Port {{ proxy_port }} -LinuxCredential $LinuxCred -Force
              
              Write-Host "Proxy $proxyHostname er tilføjet."
          } else {
              Write-Host "Proxy $proxyHostname eksisterer allerede."
          }
      register: add_proxy_result
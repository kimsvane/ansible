- name: VB365 v8.2 Download and Installation
  hosts: all
  vars:
    vb365_version: "8.2.0.2202"
    vb365_iso_url: "https://download2.veeam.com/VBO/v8/VeeamBackupMicrosoft365_8.2.0.2202.iso"
    vb365_iso_filename: "VeeamBackupMicrosoft365_8.2.0.2202.iso"
    vb365_iso_path: "C:\\{{ vb365_iso_filename }}"
    temp_dir: 'C:\Temp'
    sidecar_install_dir: 'C:\Program Files\Graylog\sidecar'
    graylog_sidecar_version: "1.4.0"
    graylog_sidecar_installer: "graylog_sidecar_installer_{{ graylog_sidecar_version }}_amd64.exe"
    graylog_sidecar_url: "https://github.com/Graylog2/collector-sidecar/releases/download/{{ graylog_sidecar_version }}/{{ graylog_sidecar_installer }}"

    # Disse variabler forventes fra Terraform-genereret fil
    # postgres_host: "{{ postgres_host }}"
    # postgres_port: "{{ postgres_port | default(5432) }}"
    # postgres_database: "{{ postgres_database }}"
    # postgres_user: "{{ postgres_user }}"
    # postgres_password: "{{ postgres_password }}"
    # nats_host: "{{ nats_host }}"
    # nats_port: "{{ nats_port | default(4222) }}"
  collections:
    - community.windows
    - ansible.windows
    - microsoft.ad
  tasks:
    - name: Set timezone to GMT Standard Time
      ansible.windows.win_timezone:
        timezone: GMT Standard Time



    - name: Configure MaxUserPort registry setting
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
        name: MaxUserPort
        data: 65000
        type: dword

    - name: Configure TcpTimedWaitDelay registry setting
      ansible.windows.win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
        name: TcpTimedWaitDelay
        data: 30
        type: dword

 
    - name: Configure DNS client settings (PowerShell alternative)
      ansible.windows.win_shell: |
            # Find the adapter that is currently connected (e.g., has an IP address)
            $adapter = Get-NetAdapter | Where-Object { $_.Status -eq "Up" -and $_.LinkSpeed -ne "" } | Select-Object -First 1
            
            # Hvis adapteren findes, sæt DNS-serverne
            if ($adapter) {
                Set-DnsClientServerAddress -InterfaceAlias $adapter.Name -ServerAddresses ("{{ network_address }}.201", "{{ network_address }}.202")
                Write-Host "Successfully set DNS for adapter $($adapter.Name)"
            } else {
                Write-Host "No active network adapter found to set DNS."
            }

    - name: Join domain
      microsoft.ad.membership:
        dns_domain_name: "{{ domain }}"
        domain_admin_user: "{{ domain_user }}@{{ domain }}"
        domain_admin_password: "{{ domain_user_password }}"
        #domain_server: "{{ domain_controller }}"
        state: domain
      register: domain_state

    - name: Display domain join result
      ansible.builtin.debug:
        var: domain_state

    - name: Configure firewall - Remote Desktop (3389)
      community.windows.win_firewall_rule:
        name: Remote Desktop
        localport: 3389
        action: allow
        direction: in
        protocol: tcp
        state: present
        enabled: yes

    - name: Configure firewall - Controller Communication (9193)
      community.windows.win_firewall_rule:
        name: Controller Communication 9193
        localport: 9193
        action: allow
        direction: in
        protocol: tcp
        state: present
        enabled: yes

    - name: Configure firewall - SMB (445)
      community.windows.win_firewall_rule:
        name: Controller Communication 445
        localport: 445
        action: allow
        direction: in
        protocol: tcp
        state: present
        enabled: yes

    - name: Configure firewall - Controller Communication (9194)
      community.windows.win_firewall_rule:
        name: Controller Communication 9194
        localport: 9194
        action: allow
        direction: in
        protocol: tcp
        state: present
        enabled: yes

    - name: Configure firewall - HTTPS (4443)
      community.windows.win_firewall_rule:
        name: Controller Communication 4443
        localport: 4443
        action: allow
        direction: in
        protocol: tcp
        state: present
        enabled: yes

    - name: Configure firewall - PostgreSQL (5432)
      community.windows.win_firewall_rule:
        name: PostgreSQL
        localport: 5432
        action: allow
        direction: out
        protocol: tcp
        state: present
        enabled: yes
      when: postgres_host is defined

    - name: Configure firewall - NATS (4222)
      community.windows.win_firewall_rule:
        name: NATS
        localport: 4222
        action: allow
        direction: out
        protocol: tcp
        state: present
        enabled: yes
      when: nats_host is defined


    - name: Download VB365 v8.2 installer
      ansible.windows.win_get_url:
        url: "{{ vb365_iso_url }}"
        dest: "{{ vb365_iso_path }}"
        timeout: 3600
      register: download_result

    - name: Display mount path for debugging
      ansible.builtin.debug:
        var: disk_image_out.mount_paths[0]

    - name: Tjek PostgreSQL forbindelse
      ansible.windows.win_shell: |
        Test-NetConnection -ComputerName {{ postgresql.postgres_host }} -Port {{ postgresql.postgres_port | default(6432) }}
      register: pg_check

    - name: Tjek NATS forbindelse  
      ansible.windows.win_shell: |
        Test-NetConnection -ComputerName {{ nats.host }} -Port {{ nats.port | default(4222) }}
      register: nats_check

    - name: Download PowerShell 7
      ansible.windows.win_get_url:
        url: https://github.com/PowerShell/PowerShell/releases/download/v7.4.6/PowerShell-7.4.6-win-x64.msi
        dest: C:\PowerShell-7.4.6-win-x64.msi

    - name: Install PowerShell 7
      ansible.windows.win_package:
        path: C:\PowerShell-7.4.6-win-x64.msi
        arguments: /qn /norestart ADD_EXPLORER_CONTEXT_MENU_OPENPOWERSHELL=1 ENABLE_PSREMOTING=1
        state: present
        product_id: "{DC88FC61-3BAA-4C5A-9867-65EDAB2A5B91}"
      async: 3600
      poll: 30

    - name: Verificer PowerShell 7 er klar
      ansible.windows.win_shell: |
        & "C:\Program Files\PowerShell\7\pwsh.exe" -NoProfile -NonInteractive -c '$PSVersionTable.PSVersion'
      register: ps7_version
      retries: 6
      delay: 10
      until: ps7_version.rc == 0
      failed_when: ps7_version.rc != 0

    - name: Check if reboot is required
      ansible.windows.win_shell: |
        $reboot = $false

        if (Test-Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Component Based Servicing\RebootPending") {
          $reboot = $true
        }

        $pfro = (Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager" -ErrorAction SilentlyContinue).PendingFileRenameOperations
        if ($pfro) { $reboot = $true }

        if (Test-Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate\Auto Update\RebootRequired") {
          $reboot = $true
        }

        if ($reboot) { "true" } else { "false" }
      register: reboot_check

    - name: Display reboot status
      debug:
        msg: "Reboot required: {{ reboot_check.stdout | trim }}"

    - name: Reboot if required
      ansible.windows.win_reboot:
        reboot_timeout: 1200
        post_reboot_delay: 120
        test_command: whoami
      when: reboot_check.stdout | trim == "true"

    - name: Mount VB365 ISO
      community.windows.win_disk_image:
        image_path: "{{ vb365_iso_path }}"
        state: present
      register: disk_image_out


    - name: Install VB365 v8.2 with external PostgreSQL and NATS
      ansible.windows.win_package:
        path: "{{ disk_image_out.mount_paths[0] }}Backup\\Veeam.Backup365.msi"
        arguments: >-
          /L*V C:\\veeam_install_log.log /qn ADDLOCAL=BR_OFFICE365,CONSOLE_OFFICE365,PS_OFFICE365,REST_OFFICE365 ACCEPT_THIRDPARTY_LICENSES=1 ACCEPT_EULA=1 CONNECTION="Host={{ postgresql.postgres_host }};Port={{ postgresql.postgres_port | default(6432) }};Database={{ postgresql.postgres_database }};Username={{ postgresql.postgres_user }};Password={{ postgresql.postgres_password }}" JETSTREAM_CONNECTION="nats://{{ nats.username }}:{{ nats.password }}@{{ nats.host }}:{{ nats.port | default(4222) }}"
        state: present
        product_id: "{3F8E3E4D-7E3E-4F3E-8E3E-4F3E8E3E4F3E}"
      async: 3600
      poll: 30
      register: install_result

    - name: Hent Veeam install log ved fejl
      ansible.windows.win_shell: Get-Content C:\veeam_install_log.log | Select-String "error|fail|Return value 3" -CaseSensitive:$false
      when: install_result is failed
      ignore_errors: true

    - name: Display installation result
      ansible.builtin.debug:
        var: install_result

    - name: Unmount ISO
      community.windows.win_disk_image:
        image_path: "{{ vb365_iso_path }}"
        state: absent


    # - name: Ensure temp directory exists
    #   ansible.windows.win_file:
    #     path: "{{ temp_dir }}"
    #     state: directory

    # - name: Download Graylog Sidecar installer
    #   ansible.windows.win_get_url:
    #     url: "{{ graylog_sidecar_url }}"
    #     dest: "{{ temp_dir }}\\{{ graylog_sidecar_installer }}"
    #     force: false

    # - name: Install Graylog Sidecar (silent)
    #   ansible.windows.win_package:
    #     path: "{{ temp_dir }}\\{{ graylog_sidecar_installer }}"
    #     arguments:
    #       - /S
    #       - "-SERVERURL={{ graylog_server_url }}"
    #       - "-APITOKEN={{ graylog_api_token }}"
    #     state: present
    #     creates_path: "{{ sidecar_install_dir }}\\graylog-sidecar.exe"

    # - name: Install Graylog Sidecar as Windows service
    #   ansible.windows.win_command:
    #     cmd: '"{{ sidecar_install_dir }}\graylog-sidecar.exe" -service install'
    #     creates: 'HKLM:\SYSTEM\CurrentControlSet\Services\graylog-sidecar'

    # - name: Ensure Graylog Sidecar service is running and set to auto-start
    #   ansible.windows.win_service:
    #     name: graylog-sidecar
    #     state: started
    #     start_mode: auto

    # - name: Allow Graylog Sidecar through Windows Firewall (outbound)
    #   community.windows.win_firewall_rule:
    #     name: "Graylog Sidecar Outbound"
    #     localport: any
    #     remoteport: any
    #     direction: out
    #     protocol: tcp
    #     program: '{{ sidecar_install_dir }}\graylog-sidecar.exe'
    #     action: allow
    #     state: present
    #     enabled: true

    # - name: Cleanup installer
    #   ansible.windows.win_file:
    #     path: "{{ temp_dir }}\\{{ graylog_sidecar_installer }}"
    #     state: absent


    - name: Reboot server after installation
      ansible.windows.win_reboot:
        reboot_timeout: 600
#Kør kommando til at sætte restore drev op
#Kør kommando til at sætte veeam til at bruge restor drev

#         # PostgreSQL connection details
# postgres_host: "postgres-server.vb365.2any.cloud"
# postgres_port: 5432
# postgres_database: "VeeamBackup365"
# postgres_user: "veeam_admin"
# postgres_password: "{{ vault_postgres_password }}"  # Brug Ansible Vault!

# # NATS connection details
# nats_host: "nats-server.vb365.2any.cloud"
# nats_port: 4222

# # Domain information (hvis de skal variere per miljø)
# domain_name: "VB365.2any.cloud"
# domain_admin_user: "ADSA@VB365.2any.cloud"
# domain_admin_password: "{{ vault_domain_password }}"  # Brug Ansible Vault!

# # DNS servers
# dns_servers:
#   - 10.251.132.7
#   - 10.251.132.6